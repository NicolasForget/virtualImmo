<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="style.css" />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/menu.js"></script>
    <script type="text/javascript" src="js/button.js"></script>
    


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">VirtualImmo</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#help">Help</a></li>
            <li><a href="#contact">Contact</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Members<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#">Mesnier Maylanie</a></li>
                <li><a href="#">Saraïs Anthony</a></li>
                <li><a href="#">Forget Nicolas</a></li>
                <li><a href="#">Ding Feng</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-12" id="main-content">
           <canvas id="map"></canvas>
           <canvas id="canvas"></canvas>
        </div>
      </div>
    </div>

    <div id="piemenu">
      	<svg width="400" height="400">
        	<g id="menu-holder" transform="translate(200,200)"></g>
      	</svg>
    </div>

    <div id="confirmMenu">
    	<svg id="confirmButtons" width="200" height="80"></svg>
    </div>



    <footer class="footer">
      <div class="container">
        <p class="text-muted">©VirtualImmo  BY Mesnier Maylanie, Saraïs Anthony, Forget Nicolas, Ding Feng</p>
      </div>
    </footer>
        <script>
          $(document).ready(function(){
            drawMap();
            init();
            // $("#canvas").outerHeight($(window).height()-$("#canvas").offset().top-Math.abs( $("#canvas").outerHeight(true) - $("#canvas").outerHeight()));
            // $("#h-input").val($("#canvas").outerHeight());
            // $("#w-input").val($("#canvas").outerWidth());
            // $("#set-size").click(function(){
            //   $("#canvas").outerHeight($("#h-input").val());
            //   $("#main-content").width($("#w-input").val());
            //   $("#canvas").outerWidth($("#main-content").width());
            // });

            // $("#map").outerHeight($(window).height()-$("#map").offset().top-Math.abs( $("#map").outerHeight(true) - $("#map").outerHeight()));
            // $("#h-input").val($("#map").outerHeight());
            // $("#w-input").val($("#map").outerWidth());
            // $("#set-size").click(function(){
            //   $("#map").outerHeight($("#h-input").val());
            //   $("#main-content").width($("#w-input").val());
            //   $("#map").outerWidth($("#main-content").width());
            // });
          });

          var canvas = document.getElementById("canvas");
          var map = document.getElementById("map");

          // holds all our rectangles
          var sofaSquare; 

          var canvas;
          var ctx;
          var WIDTH;
          var HEIGHT;
          var INTERVAL = 20;  // how often, in milliseconds, we check to see if a redraw is needed

          var isDrag = false;
          var mx, my; // mouse coordinates

           // when set to true, the canvas will redraw everything
           // invalidate() just sets this to false right now
           // we want to call invalidate() whenever we make a change
          var canvasValid = false;

          // The node (if any) being selected.
          // If in the future we want to select multiple objects, this will get turned into an array
          var mySel; 

          // The selection color and width. Right now we have a red selection with a small width
          var mySelColor = '#CC0000';
          var mySelWidth = 2;

          // we use a fake canvas to draw individual shapes for selection testing
          var ghostcanvas;
          var gctx; // fake canvas context

          // since we can drag from anywhere in a node
          // instead of just its x/y corner, we need to save
          // the offset of the mouse when we start dragging.
          var offsetx, offsety;

          // Padding and border style widths for mouse offsets
          var stylePaddingLeft, stylePaddingTop, styleBorderLeft, styleBorderTop;

          var m;
          var clickPositionX,clickPositionY;
          // $(window).resize(function(){
          //   var ctx = canvas.getContext('2d');
          //   console.log($(window).height() - 126);
          //   console.log($(window).width() - 6);
          //   ctx.canvas.height = $(window).height() - 126;
          //   ctx.canvas.width = $(window).width() - 6;
          // });

          var sofas = [
            { icon : "img/1.png", action: "sofaSelect(0);", size : {length: 100, width : 180} },
            { icon : "img/2.png", action: "sofaSelect(1);", size : {length: 100, width : 200}  },
            { icon : "img/4.png", action: "sofaSelect(2);", size : {length: 80, width : 150}  },
            { icon : "img/9.png", action: "sofaSelect(3);", size : {length: 90, width : 250}  },
            { icon : "img/8.png", action: "sofaSelect(4);", size : {length: 110, width : 220}  }  
          ];
          
          


          var windowH = $(window).height() - 130;
          var windowW = $(window).width();
          canvas.width = windowW;
          canvas.height = windowH;
          map.width = windowW;
          map.height = windowH;
          

          // canvas.addEventListener('click', function(event) {
            
          // }, false);



          


          function createSquare(canvas, x, y, height, width){
            var ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // sofaSquare = null;
            ctx.fillStyle="#FAEBD7";
            addRect(x, y, height, width, '#FAEBD7');
            ctx.fillRect(x, y, height, width);
            createConfirmMenu(x,y);
          }

          function createMenu(x,y){

            changeLayer(true);
            if(m){
              m.hide();
            }
            
            d3.select("#menu-holder").selectAll("g").each(function(){
              d3.select(this).remove();
            });
            
            m = new d3.radialMenu().radius(50).thickness(150).iconSize(120)
                        .appendTo("#menu-holder").show(sofas);

            var menu = $("#piemenu");
            menu.css('position', 'absolute');
            menu.css("left", x - 200);
            menu.css("top", y - 200);
          }

          function createConfirmMenu(x,y){
          	var svg = d3.select('#confirmButtons');

			var g = svg.append('g')
			    .attr('class', 'button')
			    .attr('transform', 'translate(100,40)')

			var text = g.append('text')
			    .text('Place it here!')

			button()
			  .container(g)
			  .text(text)
			  .count(0)
			  .cb(function() { 
			  	sofaSquare.fill = "#7FFF00"; 
			  	drawshape(ctx, sofaSquare, sofaSquare.fill);
			  	d3.select('#confirmButtons').selectAll('g').remove();
			  })();


          	var cmenu = $("#confirmMenu");
            cmenu.css('position', 'absolute');
            cmenu.css("left", x);
            cmenu.css("top", y);
            cmenu.css("z-index", "3");
          }

          function drawMap(){
            var w = map.width;
            var h = map.height;
            console.log(w);
            console.log(h);
            if (map.getContext){
              var ctx = map.getContext('2d');

              ctx.beginPath();
              ctx.moveTo(50,h - 50);
              ctx.lineTo(50,50);
              ctx.lineTo(w - 50,50);
              ctx.lineTo(w - 50,h / 2);
              ctx.lineTo(w - 60,h / 2);
              ctx.lineTo(w - 60,60);
              ctx.lineTo(60,60);
              ctx.lineTo(60,h - 60);
              ctx.lineTo(w / 2,h - 60);
              ctx.lineTo(w / 2,h - 50);
              ctx.lineTo(50,h - 50);

              ctx.moveTo(w / 2 + 60 ,h - 50);
              ctx.lineTo(w - 50 , h - 50);
              ctx.lineTo(w - 50 , h / 2 + 60);
              ctx.lineTo(w - 60 , h / 2 + 60);
              ctx.lineTo(w - 60 , h - 60);
              ctx.lineTo(w / 2 + 60 , h - 60);
              ctx.lineTo(w / 2 + 60 , h - 50);
              ctx.moveTo(w - 55 ,h / 2);
              ctx.lineTo(w - 55 ,h / 2 + 60);
              ctx.moveTo(w - 50 ,h / 2);
              ctx.lineTo(w - 50 ,h / 2 + 60);
              ctx.moveTo(w - 60 ,h / 2);
              ctx.lineTo(w - 60 ,h / 2 + 60);

              ctx.moveTo(w / 2  ,h - 55);
              ctx.arc(w / 2,h - 55,60,0,- Math.PI / 2,true);
              ctx.lineTo(w / 2 ,h - 55);

              // ctx.lineTo(50,h - 50);
              // ctx.lineTo(50,50);
              ctx.stroke();
            }
          }

          function changeLayer(flag){
            if(flag){
              d3.select("#piemenu").attr("class","piemenufirstLayer");
            }else{
              d3.select("#piemenu").attr("class","piemenuLastLayer");
            }
          }

          function sofaSelect(index){
            console.log(index);
            if(m)m.hide();
            changeLayer(false);
            var sofa = sofas[index];
            console.log(sofa.size);
            createSquare(canvas, clickPositionX, clickPositionY, sofa.size.width, sofa.size.length);
          }



          //Box object to hold data for all drawn rects
          function Box() {
            this.x = 0;
            this.y = 0;
            this.w = 1; // default width and height?
            this.h = 1;
            this.fill = '#444444';
            this.rotation = 0; // clockwise rotation in radians
          }

          //Initialize a new Box, add it, and invalidate the canvas
          function addRect(x, y, w, h, fill) {
            var rect = new Box;
            rect.x = x;
            rect.y = y;
            rect.w = w
            rect.h = h;
            rect.fill = fill;
            sofaSquare = rect;
            invalidate();
          }



          // initialize our canvas, add a ghost canvas, set draw loop
          // then add everything we want to intially exist on the canvas
          function init() {
            canvas = document.getElementById('canvas');
            HEIGHT = canvas.height;
            WIDTH = canvas.width;
            ctx = canvas.getContext('2d');
            ghostcanvas = document.createElement('canvas');
            ghostcanvas.height = HEIGHT;
            ghostcanvas.width = WIDTH;
            gctx = ghostcanvas.getContext('2d');
            
            //fixes a problem where double clicking causes text to get selected on the canvas
            canvas.onselectstart = function () { return false; }
            
            // fixes mouse co-ordinate problems when there's a border or padding
            // see getMouse for more detail
            if (document.defaultView && document.defaultView.getComputedStyle) {
              stylePaddingLeft = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingLeft'], 10)      || 0;
              stylePaddingTop  = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingTop'], 10)       || 0;
              styleBorderLeft  = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderLeftWidth'], 10)  || 0;
              styleBorderTop   = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderTopWidth'], 10)   || 0;
            }
            
            // make draw() fire every INTERVAL milliseconds
            setInterval(draw, INTERVAL);
            
            // set our events. Up and down are for dragging,
            // double click is for making new boxes
            canvas.onmousedown = myDown;
            canvas.onmouseup = myUp;
            canvas.ondblclick = myDblClick;
            
          }

          //wipes the canvas context
          function clear(c) {
            c.clearRect(0, 0, WIDTH, HEIGHT);
          }

          // While draw is called as often as the INTERVAL variable demands,
          // It only ever does something if the canvas gets invalidated by our code
          function draw() {
            if (canvasValid == false) {
              clear(ctx);
              
              // Add stuff you want drawn in the background all the time here
              
              // draw all boxes
              // var l = boxes.length;
              // for (var i = 0; i < l; i++) {
              //     // boxes[i].rotation += 0.04; // Silly rotation!
              if(sofaSquare)
                  drawshape(ctx, sofaSquare, sofaSquare.fill);
              // }
              
              // draw selection
              // right now this is just a stroke along the edge of the selected box
              if (mySel != null) {
                ctx.strokeStyle = mySelColor;
                ctx.lineWidth = mySelWidth;
                ctx.strokeRect(mySel.x,mySel.y,mySel.w,mySel.h);
              }
              
              // Add stuff you want drawn on top all the time here
              
              
              canvasValid = true;
            }
          }

          // Draws a single shape to a single context
          // draw() will call this with the normal canvas
          // myDown will call this with the ghost canvas
          function drawshape(context, shape, fill) {
            context.fillStyle = fill;
            
            if (shape.rotation != 0) {
              context.save();
              // Rotate will rotate the entire canvas clockwise from the 0,0 point
              // so we must translate 0,0 to be the center of the object
              var xx = shape.x + (shape.w/2);
              var yy = shape.y + (shape.h/2);

              context.translate(xx,yy);
              context.rotate(shape.rotation);
              x = 0 - (shape.w/2);
              y = 0 - (shape.h/2);
            } else {
              x = shape.x;
              y = shape.y;
            }
            
            // We can skip the drawing of elements that have moved off the screen:
            if (shape.x > WIDTH || shape.y > HEIGHT ||
                shape.x + shape.w < 0 || shape.y + shape.h < 0) {
              if (shape.rotation != 0) { context.restore(); }
              return;
            }
            
            context.fillRect(x,y,shape.w,shape.h);
            
            if (shape.rotation != 0) { context.restore(); }
          }

          // Happens when the mouse is moving inside the canvas
          function myMove(e){
            if (isDrag){
              getMouse(e);
              
              mySel.x = mx - offsetx;
              mySel.y = my - offsety;   
              
              // something is changing position so we better invalidate the canvas!
              invalidate();
            }
          }

          // adds a new node
          function myDblClick(event) {
            getMouse(event);
            // for this method width and height determine the starting X and Y, too.
            // so I left them as vars in case someone wanted to make them args for something and copy this code
            var x = event.pageX - canvas.offsetLeft;
            y = event.pageY - canvas.offsetTop;
            console.log(x, y);
            clickPositionX = x;
            clickPositionY = y;
                      
            createMenu(event.pageX,event.pageY);
          }

          // Happens when the mouse is clicked in the canvas
          function myDown(e){
          	d3.select('#confirmButtons').selectAll('g').remove();
            getMouse(e);
            clear(gctx);
            // var l = boxes.length;
            // for (var i = l-1; i >= 0; i--) {
            //   // draw shape onto ghost context
            if(sofaSquare){
            	sofaSquare.fill = "#FAEBD7"; drawshape(ctx, sofaSquare, sofaSquare.fill);
              drawshape(gctx, sofaSquare, 'black', 'black');
              
              // get image data at the mouse x,y pixel
              var imageData = gctx.getImageData(mx, my, 1, 1);
              var index = (mx + my * imageData.width) * 4;
              
              // if the mouse pixel exists, select and break
              if (imageData.data[3] > 0) {
                mySel = sofaSquare;
                offsetx = mx - mySel.x;
                offsety = my - mySel.y;
                mySel.x = mx - offsetx;
                mySel.y = my - offsety;
                isDrag = true;
                canvas.onmousemove = myMove;
                invalidate();
                clear(gctx);
                return;
              }
              
            }
            // havent returned means we have selected nothing
            mySel = null;
            // clear the ghost canvas for next time
            clear(gctx);
            // invalidate because we might need the selection border to disappear
            invalidate();
          }

          function myUp(){
            isDrag = false;
            canvas.onmousemove = null;
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = mySelWidth;
            if(mySel !== null){
            	ctx.strokeRect(mySel.x,mySel.y,mySel.w,mySel.h);
            	createConfirmMenu(mySel.x,mySel.y);
            }
          }

          function invalidate() {
            canvasValid = false;
          }

          // Sets mx,my to the mouse position relative to the canvas
          // unfortunately this can be tricky, we have to worry about padding and borders
          function getMouse(e) {
                var element = canvas, offsetX = 0, offsetY = 0;

                if (element.offsetParent) {
                  do {
                    offsetX += element.offsetLeft;
                    offsetY += element.offsetTop;
                  } while ((element = element.offsetParent));
                }

                // Add padding and border style widths to offset
                offsetX += stylePaddingLeft;
                offsetY += stylePaddingTop;

                offsetX += styleBorderLeft;
                offsetY += styleBorderTop;

                mx = e.pageX - offsetX;
                my = e.pageY - offsetY
          }          

        </script>
  </body>
</html>

